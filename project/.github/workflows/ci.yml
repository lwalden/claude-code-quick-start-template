# ==============================================================================
# Continuous Integration Workflow
# ==============================================================================
# This workflow runs on pull requests and pushes to main
# Customize the jobs based on your technology stack
# ==============================================================================

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Set common environment variables here
  NODE_VERSION: '20'
  DOTNET_VERSION: '8.0.x'
  PYTHON_VERSION: '3.12'
  GO_VERSION: '1.22'
  RUST_VERSION: 'stable'

jobs:
  # ============================================================================
  # Detect which files changed to conditionally run jobs
  # ============================================================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      infra: ${{ steps.filter.outputs.infra }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'src/**'
              - '*.csproj'
              - '*.sln'
              - 'requirements*.txt'
              - 'pyproject.toml'
              - 'Cargo.toml'
              - 'go.mod'
            frontend:
              - 'frontend/**'
              - 'web/**'
              - 'client/**'
              - 'package.json'
              - 'yarn.lock'
              - 'pnpm-lock.yaml'
            infra:
              - 'infrastructure/**'
              - 'terraform/**'
              - 'bicep/**'
              - '.github/workflows/**'
            docs:
              - 'docs/**'
              - '*.md'

  # ============================================================================
  # .NET Build and Test
  # ============================================================================
  # Uncomment this job if your project uses .NET
  # ============================================================================
  # dotnet:
  #   needs: changes
  #   if: needs.changes.outputs.backend == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Setup .NET
  #       uses: actions/setup-dotnet@v4
  #       with:
  #         dotnet-version: ${{ env.DOTNET_VERSION }}
  #     
  #     - name: Restore dependencies
  #       run: dotnet restore
  #     
  #     - name: Build
  #       run: dotnet build --no-restore --configuration Release
  #     
  #     - name: Test
  #       run: dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage"
  #     
  #     - name: Upload coverage
  #       uses: codecov/codecov-action@v4
  #       with:
  #         token: ${{ secrets.CODECOV_TOKEN }}
  #         fail_ci_if_error: false

  # ============================================================================
  # Node.js Build and Test
  # ============================================================================
  # Uncomment this job if your project uses Node.js
  # ============================================================================
  # node:
  #   needs: changes
  #   if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.backend == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'  # or 'yarn' or 'pnpm'
  #     
  #     - name: Install dependencies
  #       run: npm ci
  #     
  #     - name: Lint
  #       run: npm run lint
  #     
  #     - name: Type check
  #       run: npm run type-check
  #     
  #     - name: Test
  #       run: npm test -- --coverage
  #     
  #     - name: Build
  #       run: npm run build

  # ============================================================================
  # Python Build and Test
  # ============================================================================
  # Uncomment this job if your project uses Python
  # ============================================================================
  # python:
  #   needs: changes
  #   if: needs.changes.outputs.backend == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Setup Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}
  #         cache: 'pip'
  #     
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements.txt
  #         pip install -r requirements-dev.txt
  #     
  #     - name: Lint with ruff
  #       run: ruff check .
  #     
  #     - name: Type check with mypy
  #       run: mypy .
  #     
  #     - name: Test with pytest
  #       run: pytest --cov --cov-report=xml
  #     
  #     - name: Upload coverage
  #       uses: codecov/codecov-action@v4
  #       with:
  #         token: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # Rust Build and Test
  # ============================================================================
  # Uncomment this job if your project uses Rust
  # ============================================================================
  # rust:
  #   needs: changes
  #   if: needs.changes.outputs.backend == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Setup Rust
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         components: rustfmt, clippy
  #     
  #     - name: Cache cargo
  #       uses: Swatinem/rust-cache@v2
  #     
  #     - name: Format check
  #       run: cargo fmt --all -- --check
  #     
  #     - name: Clippy
  #       run: cargo clippy --all-targets --all-features -- -D warnings
  #     
  #     - name: Test
  #       run: cargo test --all-features
  #     
  #     - name: Build
  #       run: cargo build --release

  # ============================================================================
  # Go Build and Test
  # ============================================================================
  # Uncomment this job if your project uses Go
  # ============================================================================
  # go:
  #   needs: changes
  #   if: needs.changes.outputs.backend == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Setup Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version: ${{ env.GO_VERSION }}
  #     
  #     - name: Verify dependencies
  #       run: go mod verify
  #     
  #     - name: Lint
  #       uses: golangci/golangci-lint-action@v4
  #     
  #     - name: Test
  #       run: go test -v -race -coverprofile=coverage.out ./...
  #     
  #     - name: Build
  #       run: go build -v ./...

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Scan for secrets
      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
      
      # Dependency vulnerability scanning
      # Uncomment the appropriate scanner for your stack
      
      # For Node.js
      # - name: npm audit
      #   run: npm audit --audit-level=high
      
      # For Python
      # - name: Safety check
      #   run: |
      #     pip install safety
      #     safety check -r requirements.txt
      
      # For .NET
      # - name: dotnet list vulnerable packages
      #   run: dotnet list package --vulnerable --include-transitive

  # ============================================================================
  # Docker Build (if applicable)
  # ============================================================================
  # docker:
  #   needs: changes
  #   if: needs.changes.outputs.backend == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3
  #     
  #     - name: Build
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: .
  #         push: false
  #         tags: app:test
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max

  # ============================================================================
  # All Checks Pass Gate
  # ============================================================================
  # This job is used for branch protection rules
  # ============================================================================
  all-checks:
    if: always()
    needs: [changes, security]
    # Add your enabled jobs to the needs list above
    # e.g., needs: [changes, security, dotnet, node]
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All checks passed!"
