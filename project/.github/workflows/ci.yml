# ==============================================================================
# Continuous Integration Workflow
# ==============================================================================
# Runs on pull requests and pushes to main.
# The /setup command will add a build/test job for your chosen tech stack.
# ==============================================================================

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Detect which files changed to conditionally run jobs
  # ============================================================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'src/**'
              - 'app/**'
              - 'lib/**'
            frontend:
              - 'frontend/**'
              - 'web/**'
              - 'client/**'

  # ============================================================================
  # Build and Test
  # ============================================================================
  # The /setup command will generate a build job here for your stack.
  # You can also add one manually. See the template docs for examples.
  # ============================================================================

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  # ============================================================================
  # All Checks Pass Gate (for branch protection rules)
  # ============================================================================
  all-checks:
    if: always()
    needs: [changes, security]
    # Add your build job to the needs list, e.g.: needs: [changes, security, build]
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All checks passed!"
